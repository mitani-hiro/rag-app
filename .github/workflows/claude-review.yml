name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

jobs:
  feature-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Feature Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            # RAG機能検証

            あなたはRAG（Retrieval-Augmented Generation）アプリケーションの機能実装専門家です。
            このPRの変更をRAG機能の観点からレビューしてください。

            ## 専門知識
            - Next.js App Router API Routes
            - ベクトル埋め込み生成（OpenAI / AWS Bedrock）
            - pgvectorによるコサイン類似検索
            - LLMを使用した回答生成

            ## 検証項目

            ### 1. 登録フロー
            - `generateEmbedding()` が呼ばれているか
            - `saveDocument()` でテキスト＋埋め込みが保存されているか
            - エラーハンドリングが適切か

            ### 2. 検索フロー
            - クエリの `generateEmbedding()` が実行されているか
            - `searchSimilarDocuments()` が pgvector `<=>` オペレータを使用しているか
            - 取得件数（K値）が適切か

            ### 3. 回答生成
            - `generateAnswer()` にコンテキスト文書が渡されているか
            - プロンプト構成が適切か
            - ソースドキュメントの帰属が返却されているか

            ### 4. プロバイダー抽象化
            - OpenAI / Bedrock 両方のコードパスが存在するか
            - `LLM_PROVIDER` 環境変数で適切にルーティングされるか

            ## 出力フォーマット

            ## 🔧 機能検証結果

            ### 登録機能
            - 状態: [OK/NG/該当なし]
            - 詳細: [具体的な確認結果]

            ### 検索機能
            - 状態: [OK/NG/該当なし]
            - 詳細: [具体的な確認結果]

            ### 回答生成
            - 状態: [OK/NG/該当なし]
            - 詳細: [具体的な確認結果]

            ### プロバイダー抽象化
            - 状態: [OK/NG/該当なし]
            - 詳細: [具体的な確認結果]

            ### 問題点
            - [問題1: ファイル:行番号 - 説明]
            （なければ「なし」）

            ### 推奨事項
            - [推奨1]
            （なければ「なし」）
          claude_args: "--max-turns 10"

  database-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Database Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            # データベース検証

            あなたはPostgreSQLとpgvectorベクトル検索の専門家です。
            このPRの変更をデータベースの観点からレビューしてください。

            ## 専門知識
            - PostgreSQL スキーマ設計
            - pgvector 拡張（ベクトルデータ型、コサイン類似検索）
            - HNSW インデックス最適化
            - マイグレーション戦略

            ## データベース構成

            ```sql
            CREATE TABLE documents (
              id SERIAL PRIMARY KEY,
              text TEXT NOT NULL,
              embedding vector(1536) NOT NULL,  -- OpenAI: 1536, Bedrock: 1024
              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );

            CREATE INDEX documents_embedding_idx ON documents
            USING hnsw (embedding vector_cosine_ops);
            ```

            ## 検証項目

            ### 1. スキーマ整合性
            - `vector()` の次元数が `LLM_PROVIDER` と一致するか
            - プライマリキー、NOT NULL 制約が適切か
            - インデックス定義が維持されているか

            ### 2. マイグレーション
            - スキーマ変更時にマイグレーションスクリプトが含まれているか
            - 既存データへの影響が考慮されているか

            ### 3. ベクトル検索クエリ
            - `<=>` オペレータ（コサイン距離）が使用されているか
            - `ORDER BY embedding <=> $1` の形式が正しいか
            - LIMIT 句で適切な件数が指定されているか

            ### 4. パフォーマンス
            - HNSW インデックスが活用されているか
            - コネクションプーリングが適切か

            ### 5. SQLインジェクション
            - パラメータ化クエリが使用されているか
            - ユーザー入力が直接SQLに埋め込まれていないか

            ## 出力フォーマット

            ## 🗄️ データベース検証結果

            ### スキーマ整合性
            - 状態: [OK/NG/該当なし]
            - ベクトル次元: [1536/1024/確認不可]
            - 詳細: [具体的な確認結果]

            ### マイグレーション
            - 状態: [OK/NG/該当なし]
            - 詳細: [具体的な確認結果]

            ### ベクトル検索クエリ
            - 状態: [OK/NG/該当なし]
            - 詳細: [具体的な確認結果]

            ### パフォーマンス影響
            - レベル: [低/中/高]
            - 詳細: [具体的な確認結果]

            ### 問題点
            - [問題1: ファイル:行番号 - 説明]
            （なければ「なし」）

            ### 推奨事項
            - [推奨1]
            （なければ「なし」）
          claude_args: "--max-turns 10"

  # @claude メンション応答
  comment-response:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' &&
       contains(github.event.comment.body, '@claude'))
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            このPRの変更をレビューしてください。

            ## 指示
            - コードは該当箇所のみ引用（5行以内）
            - 日本語で回答
            - 簡潔にまとめる（概要は3行以内）

            ## レビュー観点
            - 機能の正しさ（RAG機能との整合性）
            - パフォーマンス（O(N²)等の問題）
            - セキュリティ（入力バリデーション）
            - デプロイ影響（環境変数、Docker）

            ## 出力フォーマット

            ## 🤖 コードレビュー結果

            ### 概要
            [1-3行で変更内容を説明]

            ### ブロッカー（マージ前に必須）
            - [ ] `ファイル名:行番号` - [問題の説明]
            （なければ「なし」）

            ### 警告（推奨）
            - [ ] [説明]
            （なければ「なし」）

            ### 提案
            - [改善案]
            （なければ「なし」）

            ---

            <details>
            <summary>🔍 機能検証</summary>

            - 状態: [OK/NG]
            - [問題があれば簡潔に記載]

            </details>

            <details>
            <summary>⚡ パフォーマンス</summary>

            - 状態: [OK/NG]
            - [問題があれば簡潔に記載]

            </details>

            <details>
            <summary>🔒 セキュリティ</summary>

            - 状態: [OK/NG]
            - [問題があれば簡潔に記載]

            </details>

            <details>
            <summary>🚀 デプロイ影響</summary>

            - 状態: [OK/NG]
            - [問題があれば簡潔に記載]

            </details>
          claude_args: "--max-turns 10"
