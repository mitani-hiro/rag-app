name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

jobs:
  review:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' &&
       contains(github.event.comment.body, '@claude'))
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        id: claude
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          allowed_tools: "Bash(gh:*),Bash(git diff*),Bash(git log*),Read,Glob,Grep"
          direct_prompt: |
            ã“ã®PRã®å¤‰æ›´ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

            ## æŒ‡ç¤º
            - ã‚³ãƒ¼ãƒ‰ã¯è©²å½“ç®‡æ‰€ã®ã¿å¼•ç”¨ï¼ˆ5è¡Œä»¥å†…ï¼‰
            - æ—¥æœ¬èªã§å›ç­”
            - ç°¡æ½”ã«ã¾ã¨ã‚ã‚‹ï¼ˆæ¦‚è¦ã¯3è¡Œä»¥å†…ï¼‰

            ## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
            - æ©Ÿèƒ½ã®æ­£ã—ã•ï¼ˆRAGæ©Ÿèƒ½ã¨ã®æ•´åˆæ€§ï¼‰
            - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆO(NÂ²)ç­‰ã®å•é¡Œï¼‰
            - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼ˆå…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
            - ãƒ‡ãƒ—ãƒ­ã‚¤å½±éŸ¿ï¼ˆç’°å¢ƒå¤‰æ•°ã€Dockerï¼‰

            ## å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

            ## ğŸ¤– ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ

            ### æ¦‚è¦
            [1-3è¡Œã§å¤‰æ›´å†…å®¹ã‚’èª¬æ˜]

            ### ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ï¼ˆãƒãƒ¼ã‚¸å‰ã«å¿…é ˆï¼‰
            - [ ] `ãƒ•ã‚¡ã‚¤ãƒ«å:è¡Œç•ªå·` - [å•é¡Œã®èª¬æ˜]
            ï¼ˆãªã‘ã‚Œã°ã€Œãªã—ã€ï¼‰

            ### è­¦å‘Šï¼ˆæ¨å¥¨ï¼‰
            - [ ] [èª¬æ˜]
            ï¼ˆãªã‘ã‚Œã°ã€Œãªã—ã€ï¼‰

            ### ææ¡ˆ
            - [æ”¹å–„æ¡ˆ]
            ï¼ˆãªã‘ã‚Œã°ã€Œãªã—ã€ï¼‰

            ---

            <details>
            <summary>ğŸ” æ©Ÿèƒ½æ¤œè¨¼</summary>

            - çŠ¶æ…‹: [OK/NG]
            - [å•é¡ŒãŒã‚ã‚Œã°ç°¡æ½”ã«è¨˜è¼‰]

            </details>

            <details>
            <summary>âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</summary>

            - çŠ¶æ…‹: [OK/NG]
            - [å•é¡ŒãŒã‚ã‚Œã°ç°¡æ½”ã«è¨˜è¼‰]

            </details>

            <details>
            <summary>ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</summary>

            - çŠ¶æ…‹: [OK/NG]
            - [å•é¡ŒãŒã‚ã‚Œã°ç°¡æ½”ã«è¨˜è¼‰]

            </details>

            <details>
            <summary>ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å½±éŸ¿</summary>

            - çŠ¶æ…‹: [OK/NG]
            - [å•é¡ŒãŒã‚ã‚Œã°ç°¡æ½”ã«è¨˜è¼‰]

            </details>
          claude_args: "--max-turns 10"
