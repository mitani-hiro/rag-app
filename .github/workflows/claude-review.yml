name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

jobs:
  feature-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Feature Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          use_sticky_comment: true
          prompt: |
            PRã®å¤‰æ›´ã‚’RAGæ©Ÿèƒ½ã®è¦³ç‚¹ã‹ã‚‰ç°¡æ½”ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

            ã€æ¤œè¨¼é …ç›®ã€‘
            1. ç™»éŒ²ãƒ•ãƒ­ãƒ¼: generateEmbedding() â†’ saveDocument()
            2. æ¤œç´¢ãƒ•ãƒ­ãƒ¼: generateEmbedding() â†’ searchSimilarDocuments()
            3. å›ç­”ç”Ÿæˆ: generateAnswer() ã¸ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ¸¡ã—
            4. ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼: OpenAI/Bedrock ä¸¡ã‚³ãƒ¼ãƒ‰ãƒ‘ã‚¹

            ã€å‡ºåŠ›ã€‘æ—¥æœ¬èªã§ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ã¿å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

            ## ğŸ”§ æ©Ÿèƒ½æ¤œè¨¼çµæœ

            | é …ç›® | çŠ¶æ…‹ | è©³ç´° |
            |------|------|------|
            | ç™»éŒ²æ©Ÿèƒ½ | OK/NG/è©²å½“ãªã— | ä¸€è¨€ã§ |
            | æ¤œç´¢æ©Ÿèƒ½ | OK/NG/è©²å½“ãªã— | ä¸€è¨€ã§ |
            | å›ç­”ç”Ÿæˆ | OK/NG/è©²å½“ãªã— | ä¸€è¨€ã§ |
            | ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ | OK/NG/è©²å½“ãªã— | ä¸€è¨€ã§ |

            ### å•é¡Œç‚¹
            ï¼ˆãªã‘ã‚Œã°ã€Œãªã—ã€ï¼‰

            ### æ¨å¥¨äº‹é …
            ï¼ˆãªã‘ã‚Œã°ã€Œãªã—ã€ï¼‰
          claude_args: "--max-turns 20 --allowedTools Read,Grep,Glob"

  database-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Database Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          use_sticky_comment: true
          prompt: |
            PRã®å¤‰æ›´ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¦³ç‚¹ã‹ã‚‰ç°¡æ½”ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

            ã€ã‚¹ã‚­ãƒ¼ãƒæƒ…å ±ã€‘
            - OpenAI: vector(1536), Bedrock: vector(1024)
            - HNSW ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨

            ã€æ¤œè¨¼é …ç›®ã€‘
            1. ã‚¹ã‚­ãƒ¼ãƒ: ãƒ™ã‚¯ãƒˆãƒ«æ¬¡å…ƒæ•°ã®æ•´åˆæ€§
            2. ã‚¯ã‚¨ãƒª: <=> ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒª
            3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ´»ç”¨
            4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–

            ã€å‡ºåŠ›ã€‘æ—¥æœ¬èªã§ä»¥ä¸‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ã¿å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

            ## ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¤œè¨¼çµæœ

            | é …ç›® | çŠ¶æ…‹ | è©³ç´° |
            |------|------|------|
            | ã‚¹ã‚­ãƒ¼ãƒæ•´åˆæ€§ | OK/NG/è©²å½“ãªã— | ä¸€è¨€ã§ |
            | ã‚¯ã‚¨ãƒª | OK/NG/è©²å½“ãªã— | ä¸€è¨€ã§ |
            | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | OK/NG/è©²å½“ãªã— | ä¸€è¨€ã§ |
            | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | OK/NG/è©²å½“ãªã— | ä¸€è¨€ã§ |

            ### å•é¡Œç‚¹
            ï¼ˆãªã‘ã‚Œã°ã€Œãªã—ã€ï¼‰

            ### æ¨å¥¨äº‹é …
            ï¼ˆãªã‘ã‚Œã°ã€Œãªã—ã€ï¼‰
          claude_args: "--max-turns 20 --allowedTools Read,Grep,Glob"

  comment-response:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' &&
       contains(github.event.comment.body, '@claude'))
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            ã“ã®PRã®å¤‰æ›´ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

            ## æŒ‡ç¤º
            - ã‚³ãƒ¼ãƒ‰ã¯è©²å½“ç®‡æ‰€ã®ã¿å¼•ç”¨ï¼ˆ5è¡Œä»¥å†…ï¼‰
            - æ—¥æœ¬èªã§å›ç­”
            - ç°¡æ½”ã«ã¾ã¨ã‚ã‚‹ï¼ˆæ¦‚è¦ã¯3è¡Œä»¥å†…ï¼‰

            ## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
            - æ©Ÿèƒ½ã®æ­£ã—ã•ï¼ˆRAGæ©Ÿèƒ½ã¨ã®æ•´åˆæ€§ï¼‰
            - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆO(NÂ²)ç­‰ã®å•é¡Œï¼‰
            - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼ˆå…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
            - ãƒ‡ãƒ—ãƒ­ã‚¤å½±éŸ¿ï¼ˆç’°å¢ƒå¤‰æ•°ã€Dockerï¼‰

            ## å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

            ## ğŸ¤– ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ

            ### æ¦‚è¦
            [1-3è¡Œã§å¤‰æ›´å†…å®¹ã‚’èª¬æ˜]

            ### ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ï¼ˆãƒãƒ¼ã‚¸å‰ã«å¿…é ˆï¼‰
            - [ ] `ãƒ•ã‚¡ã‚¤ãƒ«å:è¡Œç•ªå·` - [å•é¡Œã®èª¬æ˜]
            ï¼ˆãªã‘ã‚Œã°ã€Œãªã—ã€ï¼‰

            ### è­¦å‘Šï¼ˆæ¨å¥¨ï¼‰
            - [ ] [èª¬æ˜]
            ï¼ˆãªã‘ã‚Œã°ã€Œãªã—ã€ï¼‰

            ### ææ¡ˆ
            - [æ”¹å–„æ¡ˆ]
            ï¼ˆãªã‘ã‚Œã°ã€Œãªã—ã€ï¼‰

            ---

            <details>
            <summary>ğŸ” æ©Ÿèƒ½æ¤œè¨¼</summary>

            - çŠ¶æ…‹: [OK/NG]
            - [å•é¡ŒãŒã‚ã‚Œã°ç°¡æ½”ã«è¨˜è¼‰]

            </details>

            <details>
            <summary>âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</summary>

            - çŠ¶æ…‹: [OK/NG]
            - [å•é¡ŒãŒã‚ã‚Œã°ç°¡æ½”ã«è¨˜è¼‰]

            </details>

            <details>
            <summary>ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</summary>

            - çŠ¶æ…‹: [OK/NG]
            - [å•é¡ŒãŒã‚ã‚Œã°ç°¡æ½”ã«è¨˜è¼‰]

            </details>

            <details>
            <summary>ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤å½±éŸ¿</summary>

            - çŠ¶æ…‹: [OK/NG]
            - [å•é¡ŒãŒã‚ã‚Œã°ç°¡æ½”ã«è¨˜è¼‰]

            </details>
          claude_args: "--max-turns 10"
